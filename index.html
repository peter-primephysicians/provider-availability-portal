<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Provider Availability & Preferences</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    .month-block { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
    .month-title { font-weight: bold; margin-bottom: 5px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 5px; }
    .day { padding: 6px; border: 1px solid #ccc; text-align: center; cursor: pointer; font-size: 0.85rem; }
    .day-header { font-weight: bold; border: none; cursor: default; }
    .selected { background-color: #cce5ff; }
    button { margin-top: 15px; padding: 8px 16px; }
    .small { font-size: 0.85rem; color: #666; }
  </style>
</head>
<body>
  <h2>Provider Availability & Preferences</h2>

  <!-- This line will be filled based on role -->
  <p id="shift_info" class="small"></p>

  <p class="small">
    Please mark all days you are willing to work during this 3-month block.
    At minimum, you must complete Month 1.
  </p>

  <form id="providerForm">
    <!-- Hidden fields -->
    <input type="hidden" id="provider_id" name="provider_id" />
    <input type="hidden" id="role" name="role" />
    <input type="hidden" id="cycle_start" name="cycle_start" />
    <input type="hidden" id="month1_availability" name="month1_availability" />
    <input type="hidden" id="month2_availability" name="month2_availability" />
    <input type="hidden" id="month3_availability" name="month3_availability" />
    <input type="hidden" id="shift_template" name="shift_template" />

    <label>
      Name
      <input type="text" id="name" name="name" required />
    </label>

    <label>
      Email
      <input type="email" id="email" name="email" required />
    </label>

    <label>
      Mobile Phone
      <input type="text" id="phone" name="phone" />
    </label>

    <label>
      Scheduling Preferences (freetext)
      <textarea id="preferences" name="preferences" rows="5"
        placeholder="E.g., prefer days vs nights, max consecutive shifts, weekends yes/no, etc."></textarea>
    </label>

    <!-- Month 1 -->
    <div class="month-block">
      <div class="month-title" id="month1_label"></div>
      <div class="small">Click all days you are willing to work in this month (required).</div>
      <div id="month1_calendar" class="calendar"></div>
    </div>

    <!-- Month 2 -->
    <div class="month-block">
      <div class="month-title" id="month2_label"></div>
      <div class="small">Optional now. You can return later to add this month.</div>
      <div id="month2_calendar" class="calendar"></div>
    </div>

    <!-- Month 3 -->
    <div class="month-block">
      <div class="month-title" id="month3_label"></div>
      <div class="small">Optional now. You can return later to add this month.</div>
      <div id="month3_calendar" class="calendar"></div>
    </div>

    <button type="submit">Submit</button>
  </form>

  <p id="status"></p>

  <script>
    // ===== CONFIG: Change these for each 3-month scheduling block =====
    // Example: Jan–Mar 2026
    const BASE_YEAR = 2026;
    const BASE_MONTH = 0; // 0=Jan, 3=Apr, 6=Jul, 9=Oct

    // Read provider ID & role from URL (e.g. ?pid=ABEM_PBIGGANE&role=ABEM)
    const params = new URLSearchParams(window.location.search);
    const pid = params.get('pid') || '';
    const role = params.get('role') || '';

    document.getElementById('provider_id').value = pid;
    document.getElementById('role').value = role;

    // Prefill name from ?name=First%20Last
    const nameFromUrl = params.get('name');
    if (nameFromUrl) {
      document.getElementById('name').value = nameFromUrl;
    }

    // Prefill email from ?email=
    const emailFromUrl = params.get('email');
    if (emailFromUrl) {
      document.getElementById('email').value = emailFromUrl;
    }

    // Show role-specific shift times and set template
    const roleShiftInfo = {
      ABEM: {
        label: "Your shift template for selected days: ABEM 8:00 am – 8:00 pm",
        template: "08:00-20:00"
      },
      FMIM: {
        label: "Your shift template for selected days: FM/IM 12:00 pm – 12:00 am",
        template: "12:00-00:00"
      },
      APP: {
        label: "Your shift template for selected days: APP 7:00 am – 7:00 pm",
        template: "07:00-19:00"
      }
    };

    const shiftInfo = roleShiftInfo[role];
    if (shiftInfo) {
      document.getElementById('shift_info').textContent = shiftInfo.label;
      document.getElementById('shift_template').value = shiftInfo.template;
    } else {
      document.getElementById('shift_info').textContent =
        "Shifts (fixed by role): ABEM 8a–8p, FM/IM 12p–12a, APP 7a–7p.";
    }

    // Set cycle_start to first day of Month 1
    const cycleStartDate = new Date(BASE_YEAR, BASE_MONTH, 1);
    const cycleStartIso = cycleStartDate.toISOString().split('T')[0];
    document.getElementById('cycle_start').value = cycleStartIso;

    function buildMonthCalendar(year, monthIndex, containerId, hiddenInputId, labelId) {
      const container = document.getElementById(containerId);
      const labelEl = document.getElementById(labelId);
      const hiddenInput = document.getElementById(hiddenInputId);
      container.innerHTML = '';

      const monthNames = [
        'January','February','March','April','May','June',
        'July','August','September','October','November','December'
      ];
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

      const monthName = monthNames[monthIndex];
      labelEl.textContent = `${monthName} ${year}`;

      const selectedDates = new Set();

      // Weekday headers
      weekdays.forEach(d => {
        const h = document.createElement('div');
        h.textContent = d;
        h.className = 'day day-header';
        container.appendChild(h);
      });

      const firstDay = new Date(year, monthIndex, 1);
      const lastDay = new Date(year, monthIndex + 1, 0);
      const numDays = lastDay.getDate();
      const startWeekday = firstDay.getDay(); // 0=Sun

      // Blank cells before the first of the month
      for (let i = 0; i < startWeekday; i++) {
        const empty = document.createElement('div');
        container.appendChild(empty);
      }

      for (let d = 1; d <= numDays; d++) {
        const dateObj = new Date(year, monthIndex, d);
        const iso = dateObj.toISOString().split('T')[0];

        const dayEl = document.createElement('div');
        dayEl.className = 'day';
        dayEl.textContent = d;
        dayEl.dataset.date = iso;

        dayEl.addEventListener('click', () => {
          if (selectedDates.has(iso)) {
            selectedDates.delete(iso);
            dayEl.classList.remove('selected');
          } else {
            selectedDates.add(iso);
            dayEl.classList.add('selected');
          }
          hiddenInput.value = JSON.stringify(Array.from(selectedDates));
        });

        container.appendChild(dayEl);
      }
    }

    // Build the three month calendars
    buildMonthCalendar(BASE_YEAR, BASE_MONTH,     'month1_calendar', 'month1_availability', 'month1_label');
    buildMonthCalendar(BASE_YEAR, BASE_MONTH + 1, 'month2_calendar', 'month2_availability', 'month2_label');
    buildMonthCalendar(BASE_YEAR, BASE_MONTH + 2, 'month3_calendar', 'month3_availability', 'month3_label');

    // Form submission
    document.getElementById('providerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Submitting...';

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      // Enforce: Month 1 must have at least one available day
      if (!data.month1_availability || data.month1_availability === '[]') {
        statusEl.textContent = 'Please select at least one available day in Month 1.';
        return;
      }

      try {
        await fetch('https://script.google.com/macros/s/AKfycbzEeDIAtvj93ur72Mc1mPiue9OaW7PpmOFOjWk3CBnGLUm95gjn7Pu7JszUJm0e3mf8yw/exec', {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify(data)
        });
        statusEl.textContent = 'Thank you! Your availability has been submitted.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error submitting form. Please contact the scheduler if this continues.';
      }
    });
  </script>
</body>
</html>
