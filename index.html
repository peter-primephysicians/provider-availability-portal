<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Provider Availability & Preferences</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
    .month-block { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
    .month-title { font-weight: bold; margin-bottom: 5px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 5px; }
    .day { padding: 6px; border: 1px solid #ccc; text-align: center; cursor: pointer; font-size: 0.85rem; }
    .day-header { font-weight: bold; border: none; cursor: default; }
    .selected { background-color: #cce5ff; }
    button { margin-top: 15px; padding: 8px 16px; }
    #status { margin-top: 10px; font-weight: bold; }
    .small { font-size: 0.85rem; color: #555; }
  </style>
</head>
<body>
  <h2>Provider Availability & Preferences</h2>
  <p>Please confirm your contact information and select your available days for this 3-month block.</p>

  <p id="shift_info" class="small"></p>

  <!-- New note about day vs night shift -->
  <p class="small"><strong>For ABEM providers:</strong> 8am–8pm or 8pm–8am shifts. Please specify your day/night preference in the notes below.</p>

  <form id="providerForm">
    <input type="hidden" id="provider_id" name="provider_id" />
    <input type="hidden" id="role" name="role" />
    <input type="hidden" id="cycle_start" name="cycle_start" />
    <input type="hidden" id="month1_availability" name="month1_availability" />
    <input type="hidden" id="month2_availability" name="month2_availability" />
    <input type="hidden" id="month3_availability" name="month3_availability" />
    <input type="hidden" id="shift_template" name="shift_template" />

    <label>
      Name
      <input type="text" id="name" name="name" required />
    </label>

    <label>
      Email
      <input type="email" id="email" name="email" required />
    </label>

    <label>
      Mobile Phone
      <input type="tel" id="phone" name="phone" />
    </label>

    <label>
      Scheduling Preferences / Notes
      <textarea id="preferences" name="preferences" rows="3" placeholder="Please state if you prefer DAY or NIGHT shifts (ABEM)."></textarea>
    </label>

    <div class="month-block">
      <div class="month-title" id="month1_label"></div>
      <div id="month1_calendar" class="calendar"></div>
    </div>

    <div class="month-block">
      <div class="month-title" id="month2_label"></div>
      <div id="month2_calendar" class="calendar"></div>
    </div>

    <div class="month-block">
      <div class="month-title" id="month3_label"></div>
      <div id="month3_calendar" class="calendar"></div>
    </div>

    <button type="submit" id="submit_button">Submit Availability</button>
    <div id="status"></div>
  </form>

  <script>
    const BASE_YEAR = 2026;
    const BASE_MONTH = 0;

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEeDIAtvj93ur72Mc1mPiue9OaW7PpmOFOjWk3CBnGLUm95gjn7Pu7JszUJm0e3mf8yw/exec';

    const params = new URLSearchParams(window.location.search);
    const pid = params.get('pid') || '';
    const role = params.get('role') || '';

    document.getElementById('provider_id').value = pid;
    document.getElementById('role').value = role;

    const nameFromUrl = params.get('name');
    if (nameFromUrl) document.getElementById('name').value = decodeURIComponent(nameFromUrl);

    const emailFromUrl = params.get('email');
    if (emailFromUrl) document.getElementById('email').value = decodeURIComponent(emailFromUrl);

    const roleShiftInfo = {
      ABEM: {
        label: 'Your shift template for selected days: ABEM 8:00 am – 8:00 pm or 8:00 pm – 8:00 am',
        template: '08:00-20:00 / 20:00-08:00'
      },
      FMIM: {
        label: 'Your shift template for selected days: FM/IM 12:00 pm – 12:00 am',
        template: '12:00-00:00'
      },
      APP: {
        label: 'Your shift template for selected days: APP 7:00 am – 7:00 pm',
        template: '07:00-19:00'
      }
    };

    const shiftInfo = roleShiftInfo[role];
    if (shiftInfo) {
      document.getElementById('shift_info').textContent = shiftInfo.label;
      document.getElementById('shift_template').value = shiftInfo.template;
    } else {
      document.getElementById('shift_info').textContent =
        'Shifts by role: ABEM 8a–8p or 8p–8a; FM/IM 12p–12a; APP 7a–7p.';
    }

    const cycleStartDate = new Date(BASE_YEAR, BASE_MONTH, 1);
    const cycleStartIso = cycleStartDate.toISOString().split('T')[0];
    document.getElementById('cycle_start').value = cycleStartIso;

    function buildMonthCalendar(year, monthIndex, containerId, hiddenInputId, labelId) {
      const container = document.getElementById(containerId);
      const labelEl = document.getElementById(labelId);
      const hiddenInput = document.getElementById(hiddenInputId);
      container.innerHTML = '';

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      labelEl.textContent = monthNames[monthIndex] + ' ' + year;

      const selectedDates = new Set();

      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      weekdays.forEach(d => {
        const h = document.createElement('div');
        h.textContent = d;
        h.className = 'day day-header';
        container.appendChild(h);
      });

      const firstDay = new Date(year, monthIndex, 1);
      const lastDay = new Date(year, monthIndex + 1, 0);
      const numDays = lastDay.getDate();
      const startWeekday = firstDay.getDay();

      for (let i = 0; i < startWeekday; i++) {
        const empty = document.createElement('div');
        container.appendChild(empty);
      }

      for (let d = 1; d <= numDays; d++) {
        const dateObj = new Date(year, monthIndex, d);
        const iso = dateObj.toISOString().split('T')[0];

        const dayEl = document.createElement('div');
        dayEl.className = 'day';
        dayEl.textContent = d;
        dayEl.dataset.date = iso;

        dayEl.addEventListener('click', () => {
          if (dayEl.classList.contains('disabled')) return;

          if (selectedDates.has(iso)) {
            selectedDates.delete(iso);
